From b1917aa2e17cf68c717780f7f0fcefcb942c89d7 Mon Sep 17 00:00:00 2001
From: Vasily Khoruzhick <anarsoul@gmail.com>
Date: Mon, 12 Nov 2018 10:26:31 -0800
Subject: [PATCH] lima: fix tiling/untiling partial textures

staging size is smaller than actual texture, so we need to take it
into account.

Signed-off-by: Vasily Khoruzhick <anarsoul@gmail.com>
---
 src/gallium/drivers/lima/lima_tiling.c | 16 ++++++++--------
 1 file changed, 8 insertions(+), 8 deletions(-)

diff --git a/src/gallium/drivers/lima/lima_tiling.c b/src/gallium/drivers/lima/lima_tiling.c
index 12e5c79f9c..0042c377e2 100644
--- a/src/gallium/drivers/lima/lima_tiling.c
+++ b/src/gallium/drivers/lima/lima_tiling.c
@@ -51,11 +51,11 @@ lima_store_tiled_image_bpp4(void *dst, const void *src,
                                uint32_t dst_stride,
                                uint32_t src_stride)
 {
-   for (int y = box->y; y < box->height; ++y) {
+   for (int y = box->y, src_y = 0; src_y < box->height; ++y, ++src_y) {
       int block_y = y & ~0x0f;
       int rem_y = y & 0x0F;
       int block_start_s = block_y * dst_stride;
-      int source_start = y * src_stride;
+      int source_start = src_y * src_stride;
 
       for (int x = box->x; x < box->width; ++x) {
          int block_x_s = (x >> 4) * 256;
@@ -77,11 +77,11 @@ lima_store_tiled_image_generic(void *dst, const void *src,
                                uint32_t src_stride,
                                uint32_t bpp)
 {
-   for (int y = box->y; y < box->height; ++y) {
+   for (int y = box->y, src_y = 0; src_y < box->height; ++y, ++src_y) {
       int block_y = y & ~0x0f;
       int rem_y = y & 0x0F;
       int block_start_s = block_y * dst_stride;
-      int source_start = y * src_stride;
+      int source_start = src_y * src_stride;
 
       for (int x = box->x; x < box->width; ++x) {
          int block_x_s = (x >> 4) * 256;
@@ -104,11 +104,11 @@ lima_load_tiled_image_bpp4(void *dst, const void *src,
                               uint32_t dst_stride,
                               uint32_t src_stride)
 {
-   for (int y = box->y; y < box->height; ++y) {
+   for (int y = box->y, dest_y = 0; dest_y < box->height; ++y, ++dest_y) {
       int block_y = y & ~0x0f;
       int rem_y = y & 0x0F;
       int block_start_s = block_y * src_stride;
-      int dest_start = y * dst_stride;
+      int dest_start = dest_y * dst_stride;
 
       for (int x = box->x; x < box->width; ++x) {
          int block_x_s = (x >> 4) * 256;
@@ -130,11 +130,11 @@ lima_load_tiled_image_generic(void *dst, const void *src,
                               uint32_t src_stride,
                               uint32_t bpp)
 {
-   for (int y = box->y; y < box->height; ++y) {
+   for (int y = box->y, dest_y = 0; dest_y < box->height; ++y, ++dest_y) {
       int block_y = y & ~0x0f;
       int rem_y = y & 0x0F;
       int block_start_s = block_y * src_stride;
-      int dest_start = y * dst_stride;
+      int dest_start = dest_y * dst_stride;
 
       for (int x = box->x; x < box->width; ++x) {
          int block_x_s = (x >> 4) * 256;
-- 
2.19.1

