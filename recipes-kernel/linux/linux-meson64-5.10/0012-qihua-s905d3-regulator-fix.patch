From c325965af34a37fdc3ab55450afc8d4a7c4ade9f Mon Sep 17 00:00:00 2001
From: changzhijie <elecboy@126.com>
Date: Fri, 25 Jun 2021 16:12:12 +0800
Subject: [PATCH 12/12] qihua s905d3 regulator fix

---
 .../boot/dts/amlogic/meson-qihua-s905d3.dtsi  | 36 +------------------
 .../dts/amlogic/meson-sm1-qihua-s905d3.dts    | 17 +++++++++
 .../dts/amlogic/meson-sm1-sports-cle-v4.dts   | 30 ++++++++++++++++
 3 files changed, 48 insertions(+), 35 deletions(-)

diff --git a/arch/arm64/boot/dts/amlogic/meson-qihua-s905d3.dtsi b/arch/arm64/boot/dts/amlogic/meson-qihua-s905d3.dtsi
index 44f8233f8dc8..a37b456e9837 100644
--- a/arch/arm64/boot/dts/amlogic/meson-qihua-s905d3.dtsi
+++ b/arch/arm64/boot/dts/amlogic/meson-qihua-s905d3.dtsi
@@ -76,9 +76,7 @@ vcc_5v: regulator-vcc_5v {
 		regulator-min-microvolt = <5000000>;
 		regulator-max-microvolt = <5000000>;
 		vin-supply = <&dc_in>;
-
-		gpio = <&gpio GPIOH_8 GPIO_OPEN_DRAIN>;
-		enable-active-high;
+		regulator-always-on;
 	};
 
 	vcc_1v8: regulator-vcc_1v8 {
@@ -127,17 +125,6 @@ vsys_3v3: regulator-vsys_3v3 {
 		regulator-always-on;
 	};
 
-	usb_pwr: regulator-usb_pwr {
-		compatible = "regulator-fixed";
-		regulator-name = "USB_PWR";
-		regulator-min-microvolt = <5000000>;
-		regulator-max-microvolt = <5000000>;
-		vin-supply = <&vcc_5v>;
-
-		gpio = <&gpio GPIOA_6 GPIO_ACTIVE_HIGH>;
-		enable-active-high;
-	};
-
 	hdmi-connector {
 		compatible = "hdmi-connector";
 		type = "a";
@@ -326,10 +313,6 @@ &ir {
 	linux,rc-map-name = "rc-khadas";
 };
 
-&pcie {
-	reset-gpios = <&gpio GPIOA_8 GPIO_ACTIVE_LOW>;
-};
-
 &pwm_ef {
         status = "okay";
         pinctrl-0 = <&pwm_e_pins>;
@@ -460,20 +443,3 @@ &uart_AO {
 	pinctrl-0 = <&uart_ao_a_pins>;
 	pinctrl-names = "default";
 };
-
-&usb2_phy0 {
-	phy-supply = <&dc_in>;
-};
-
-&usb2_phy1 {
-	phy-supply = <&usb_pwr>;
-};
-
-&usb3_pcie_phy {
-	phy-supply = <&usb_pwr>;
-};
-
-&usb {
-	status = "okay";
-	dr_mode = "host";
-};
diff --git a/arch/arm64/boot/dts/amlogic/meson-sm1-qihua-s905d3.dts b/arch/arm64/boot/dts/amlogic/meson-sm1-qihua-s905d3.dts
index 88851b5fe5ba..70c46a1c9d06 100644
--- a/arch/arm64/boot/dts/amlogic/meson-sm1-qihua-s905d3.dts
+++ b/arch/arm64/boot/dts/amlogic/meson-sm1-qihua-s905d3.dts
@@ -83,3 +83,20 @@ &pwm_AO_cd {
 &sd_emmc_a {
 	sd-uhs-sdr50;
 };
+
+&usb2_phy0 {
+	phy-supply = <&dc_in>;
+};
+
+&usb2_phy1 {
+	phy-supply = <&dc_in>;
+};
+
+&usb3_pcie_phy {
+	phy-supply = <&dc_in>;
+};
+
+&usb {
+	status = "okay";
+	dr_mode = "host";
+};
diff --git a/arch/arm64/boot/dts/amlogic/meson-sm1-sports-cle-v4.dts b/arch/arm64/boot/dts/amlogic/meson-sm1-sports-cle-v4.dts
index 68f3d37c44ef..f879c7c18325 100644
--- a/arch/arm64/boot/dts/amlogic/meson-sm1-sports-cle-v4.dts
+++ b/arch/arm64/boot/dts/amlogic/meson-sm1-sports-cle-v4.dts
@@ -44,6 +44,19 @@ vddcpu: regulator-vddcpu {
 		regulator-boot-on;
 		regulator-always-on;
 	};
+
+	usb_pwr: regulator-usb_pwr {
+		compatible = "regulator-fixed";
+		regulator-name = "USB_PWR";
+		regulator-min-microvolt = <5000000>;
+		regulator-max-microvolt = <5000000>;
+		vin-supply = <&vcc_5v>;
+
+		gpio = <&gpio GPIOA_7 GPIO_ACTIVE_HIGH>;
+		enable-active-high;
+	};
+
+
 };
 
 &cpu0 {
@@ -101,3 +114,20 @@ &uart_C {
 		pinctrl-0 = <&uart_c_pins>;
 		pinctrl-names = "default";
 };
+
+&usb2_phy0 {
+	phy-supply = <&usb_pwr>;
+};
+
+&usb2_phy1 {
+	phy-supply = <&dc_in>;
+};
+
+&usb3_pcie_phy {
+	phy-supply = <&dc_in>;
+};
+
+&usb {
+	status = "okay";
+	dr_mode = "host";
+};
-- 
2.25.1

